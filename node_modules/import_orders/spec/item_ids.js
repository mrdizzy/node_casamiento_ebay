var vows = require('vows'),
    assert = require('assert'),
    cradle = require('cradle'),
    AddOrdersToDatabase = require('import_orders/add_orders_to_database'),
    eBayTradingAPI = require('ebay_trading_api');

var db = new(cradle.Connection)('http://casamiento.iriscouch.com', 5984, {
    cache: true
}).database('test_ebay');

resetDb("2011-04-16T14:320Z", function() {});

var appId = 'Casmient-2aff-4dab-9163-50f440216b96',
    devId = 'c8d4d396-f869-44d9-8798-df4c2de90717',
    siteId = '3',
    certId = '454dd9f0-47d0-4871-ab91-ab0038a59cd3',
    authToken = 'AgAAAA**AQAAAA**aAAAAA**kRoiTg**nY+sHZ2PrBmdj6wVnY+sEZ2PrA2dj6wFk4CoAZeCpQ6dj6x9nY+seQ**JpMBAA**AAMAAA**oZA6Ywa6Ma6zNlkw3cqilP+685HQPlP4Bf1XAf+2Rt9V77dU94zFnoj4nhflnUipahn1Fy2roxApfA5ELDRgedWuspTUBirBQ5bAsuq9Btysg3p4KCq5+vsLLi3gyElWAOOOEvjTe24GHXDyHxrJsci0Ht3gMvOQ0rllbdiplsymNRY0+lXrS4jGrLRV3VCwbA2rAuhDhEaJbBH0GNP+YRO2GEerOQUGmA1/zeGYOfa/ZyU/7vQYZoBFG+v+31rxfqlOVo53o9lOo2QVfI1TDRtlsQBaBe159Shbe686AdRod5zAlimUtpzV9/9OqeMDGHqjWi39CsCjTDctOsLm3Ck/h8nJcOkOHCa2aDvW1ney+77L8HljBIBCNBkNookq13s51zRjQh+vekwBi2ja0hZgIlKULFp3QZdF8np9qlhPjWT90udSQiy2hczfFQmK/vCW2dY8OD+6bcPLQa/ruTVMMLQKga3Hdi4oFxJlhLcH3hpi4Z4vunOYnxGhtva2iQpLUfRBwHpCNr2swDQDT8Y4BLkn0GpNAqaOBX700f+uywf0BnOwYwdyL7+kx/8TMR0lwTJvmlPguukEY/zMtrTIChiX6sDAAXTep9H5plEvUKmBwwqxo+Jy15kIkkmMQh5eq58I+/Zw+PWF7sNn7rWLTQyqexrPImWG3hqQlNF2O4F29DWQCfKtiD+Y+RzOF3vngtgeQmCbdWKnP9OXaxIitTuRsDagj5ebjU0DNWkX5/6eQlDScp3fVMNi0pgf';

var api = new eBayTradingAPI(appId, siteId, devId, certId, authToken);

api.makeRequest("GetOrders", function(xmlResult) {
    AddOrdersToDatabase(db, xmlResult, function() {});
        
}, { NumberOfDays: "30" }, "json");

function resetDb(newTime, callback) {
    db.all(function(e, r) {
        if (r.length > 0) {
            var waiting = r.length;
            for (var i = 0; i < r.length; i++) {

                db.remove(r[i].id, r[i].value.rev, function(a, b) {
                    console.log("removing");
                    waiting--
                    if (!waiting) {
                        updateTime();
                    }
                });
            }
        }
        else {
            updateTime();
        }
    });

    function updateTime() {
        db.save("time", {
            lastUpdated: newTime
        }, function(error, results) {
            if (error) {
                console.log(error, results);
            }
            else {
                callback();
            }
        })
    }
}