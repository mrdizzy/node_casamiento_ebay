var OrdersResponse = require('./response');

function AddOrdersToDatabase(db, jsonData, callback) {

    var response = new OrdersResponse(jsonData);

    db.save(response.allOrders, function(err, res) {
        if (err) {
            console.log(err);
            throw ("Unable to save raw orders. Error: " + err.error + " Reason: " + err.reason);
        }
        else {
            saveOrdersSeparately(res)
        }
    })

    function saveOrdersSeparately(documents) {
        var waiting = documents.length;
        documents.forEach(function(doc) {
            if (doc.error == 'conflict') {
                db.merge(response.ordersByID[doc.id], function(error, response) {
                    if (error) {
                        console.log(error, doc);
                    }
                    else {
                        waiting--;
                        if (!waiting) {
                            updateTime();
                        }
                    }
                });
            }
            else {
                waiting--;
                if (!waiting) {
                    updateTime();
                }
            }
        })
    }

    function updateTime() {
        db.merge('time', {
            lastUpdated: response.Timestamp
        }, function(err, res) {
            if (err) {
                console.log(err);
                throw ("Unable to update time: " + err);
            }
            else {
                combineOrders()
            }
        });
    }

    function combineOrders() {
        console.log("Combining Orders");
       
          db.get(response.orderLineItemIDs, function(err, res) {
              res.forEach(function(order) {
                 if(order.error) {
                     console.log(order.error);
                 }
                else {
                    db.remove(order._id, order._rev, function(e, r) {
                     console.log(e, r);   
                    })
                }
              });
          });
        
        callback();
    }
}
module.exports = AddOrdersToDatabase;